{"version":3,"sources":["video_aqua_pc.js"],"names":["window","requirejs","player","AquaPlayerService","Timer","videoLastPlayedTime","confirm","setCurrentPlaybackTime","console","videoDuration","then","seconds","pause","catch","error","bindEvent","ec","msg","NPlayer","state","sessionProgressStartLogger","PlayState","Playing","info","timerLog","reset","timerLoggingInterval","Stopped","Paused","videoEndTimeLogger","showPlayBtn","setTimeout","secondTimer","$","removeClass","log","addEventListener","startValues","waitMessage","html","getTimeValues","toString","e","alert","location","axios","all","deleteVideoLog","deleteSessionLog","spread","res1","res2","reload","setPlayer","timer","videoPlayTimeLogger","stop","checkVideoDuration","videoCurrentTime","btnReplayVideo","ajax","data","video_id","played_seconds","video_duration","currenttime","training_user_id","trainingUserId","done","videoId","timerLogPlayedSeconds","res","videoTotalPlayedSeconds","total_played_seconds","type","success","course_id","course_list_id","url","playerContainer","href","nextUrl","btnPlayNext","addClass","delete","params","response","aquaHtml5","aquaWindow","sessionHasEnded","parent","osName","options","watermark","initPlayer","callback","obj","getDuration","on","event","preventDefault","sessionProgressEndLogger"],"mappings":"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","file":"../javascripts/video_aqua_pc.js","sourcesContent":["window.requirejs(\n  [\n    'common',\n    'aquaPlayerService',\n    'easyTimer',\n    'jqueryTimer'\n  ],\nfunction (Util, AquaPlayerService, Timer) {\n  var $ = $ || window.$;\n  var axios = axios || window.axios;\n  var osName = Util.getOSName();\n\n  var player = null;\n  var playerContainer = $('.videoplayer');\n  var aquaHtml5 = $('#aqua_html5');\n  var aquaWindow = $('#aqua_html5');\n  var btnPlayNext = $('#btn_play_next');\n  var btnReplayVideo = $('#btn_replay_video');\n\n  var timerLoggingInterval = playerContainer.data('interval'); // log every 5 seconds\n  var timerLog = null;\n  var timerLogPlayedSeconds = 0; // 시청시간(초)\n  var secondTimer = new Timer();\n\n  var waitMessage = $('#countdown .values'); // $('.wait-message');\n  var sessionHasEnded = false;\n  var nextUrl = btnPlayNext.parent().attr('href');\n  var videoDuration = null; // 비디오 러닝타임\n  var videoCurrentTime; // 비디오 현재 시청시간\n  var videoId = playerContainer.data('id'); // video 테이블의 id\n  var videoTotalPlayedSeconds = playerContainer.data('total-play'); // 비디오 총 시청시간\n  var videoLastPlayedTime = playerContainer.data('current-time'); // 마지막 재생시점\n  var trainingUserId = btnPlayNext.data('training-user-id');\n\n  $(function () {\n    if (osName === 'Windows') {\n      aquaHtml5.show();\n    } else {\n      aquaWindow.show();\n    }\n\n    var options = {\n      fileUrl: $('#video').data('url'),\n      watermark: $('#video').data('watermark'),\n      callback: function (obj) {\n        if (obj) {\n          player = obj;\n          initPlayer();\n        }\n      }\n    };\n    AquaPlayerService = new AquaPlayerService(options);\n  });\n\n  function initPlayer () {\n    player.setVolume(0.5);\n    videoDuration = player.getDuration();\n    setPlayer();\n\n    if (videoLastPlayedTime < videoDuration - 5) {\n      if (window.confirm('마지막 재생시점으로 이동하시겠습니까?')) {\n        player.setCurrentPlaybackTime(videoLastPlayedTime).then(function (seconds) {\n          player.pause();\n        }).catch(function (error) {\n          console.error(error);\n        });\n      }\n    }\n\n    player.bindEvent('Error', function (ec, msg) {\n      console.error(msg);\n    });\n\n    player.bindEvent('PlayStateChanged', function (state) {\n      switch (state) {\n      case window.NPlayer.PlayState.Playing:\n        console.info('player: playing');\n\n        // 세션시작로그\n        sessionProgressStartLogger();\n\n        // 로깅 시간간격 설정\n        timerLog.reset(1000 * timerLoggingInterval);\n        break;\n\n      case window.NPlayer.PlayState.Stopped: // 정지\n      case window.NPlayer.PlayState.Paused:  // 일시정지\n        console.info('player: stop/pause');\n\n        // 로깅 일시정지\n        timerLog.pause();\n\n        // 비디오 시청 종료일시 기록\n        videoEndTimeLogger();\n        break;\n      }\n    });\n\n    player.bindEvent('PlaybackCompleted', function () {\n      console.info('player: ended');\n\n      // 로깅 일시정지\n      timerLog.pause();\n\n      // 총 시청시간에 따라 다음 버튼 표시\n      showPlayBtn(videoTotalPlayedSeconds + timerLoggingInterval);\n\n      // 비디오 시청 종료일시 기록\n      videoEndTimeLogger();\n\n      // 세션 종료 시 대기 타이머 시작\n      if (!sessionHasEnded) {\n        setTimeout(function () {\n          $('.timer').removeClass('blind');\n\n          console.log('second timer started');\n          secondTimer.start({countdown: true, startValues: {seconds: 30}});\n\n          waitMessage.html(secondTimer.getTimeValues().toString() + ' 초 이내 <b>다음</b> 버튼을 클릭해주세요.');\n\n          secondTimer.addEventListener('secondsUpdated', function (e) {\n            waitMessage.html(secondTimer.getTimeValues().toString() + ' 초 이내 <b>다음</b> 버튼을 클릭해주세요.');\n          });\n\n          secondTimer.addEventListener('targetAchieved', function (e) {\n            waitMessage.html('학습 초기화 중입니다..');\n\n            setTimeout(function () {\n              window.alert('30초 동안 다음 버튼을 누르지 않아 학습을 초기화 하였습니다.\\n\\n재시청 해주시기 바랍니다.');\n\n              axios.all([ deleteVideoLog(), deleteSessionLog() ])\n              .then(axios.spread(function (res1, res2) {\n                window.location.reload();\n              }));\n            }, 3000);\n          });\n        }, 1000);\n      }\n    });\n  }\n\n  /**\n   * Player 를 셋팅한다.\n   */\n  function setPlayer () {\n    if (videoDuration) {\n      timerLog = $.timer(1000 * timerLoggingInterval, videoPlayTimeLogger, true);\n      timerLog.stop();\n      checkVideoDuration();\n    } else {\n      console.error('재생시간을 확인할 수 없습니다.');\n    }\n  }\n\n  /**\n   * 비디오 재생시간이 존재하는지 여부 체크\n   */\n  function checkVideoDuration () {\n    // 총 릴타임의 80% 이상을 시청한 경우 다음버튼을 활성화 한다.\n    showPlayBtn(videoTotalPlayedSeconds);\n  }\n\n    /**\n   * 시청시간 로깅\n   */\n  function videoPlayTimeLogger () {\n    console.log('logging...');\n    timerLogPlayedSeconds += timerLoggingInterval;\n\n    var seconds = player.getCurrentPlaybackTime();\n\n    if ((videoCurrentTime > 0) && videoCurrentTime === seconds) {\n      player.pause().then(function () {\n        console.log('비디오가 중지되었습니다.');\n        btnReplayVideo.removeClass('blind');\n      }).catch(function (error) {\n        console.error(error);\n      });\n      return;\n    }\n\n    videoCurrentTime = seconds;\n\n    $.ajax({\n      type: 'POST',\n      url: '/video/log/playtime',\n      data: {\n        training_user_id: trainingUserId,\n        video_id: videoId,\n        played_seconds: timerLogPlayedSeconds,\n        video_duration: videoDuration,\n        currenttime: seconds\n      }\n    }).done(function (res) {\n      if (!res.success) {\n        console.error(res.msg);\n\n        // 오류 발생 시 타이머와 비디오 재생을 멈춘다.\n        player.pause().then(function () {\n        }).catch(function (error) {\n          console.error(error);\n        });\n      } else {\n        timerLogPlayedSeconds = 0;\n        // 총 릴타임의 80% 이상을 시청한 경우 다음버튼을 활성화 한다.\n        videoTotalPlayedSeconds = res.total_played_seconds;\n        showPlayBtn(videoTotalPlayedSeconds);\n      }\n    });\n  }\n\n  /**\n   * 비디오 시청 종료시간 로깅\n   */\n  function videoEndTimeLogger () {\n    console.log('video log end');\n    $.ajax({\n      type: 'POST',\n      url: '/video/log/endtime',\n      data: {\n        video_id: videoId\n      }\n    }).done(function (res) {\n      if (!res.success) {\n        console.error(res.msg);\n      } else {\n      // console.info('종료시간 기록!');\n      }\n    });\n  }\n\n  /**\n   * 세션 시작일시 로깅\n   */\n  function sessionProgressStartLogger () {\n    $.ajax({\n      type: 'POST',\n      url: '/session/log/starttime',\n      data: {\n        training_user_id: playerContainer.data('training-user-id'),\n        course_id: playerContainer.data('course-id'),\n        course_list_id: playerContainer.data('course-list-id')\n      }\n    }).done(function (res) {\n      if (!res.success) {\n        console.error(res.msg);\n      }\n    });\n  }\n\n/**\n * 다음버튼 클릭 시 발생 이벤트\n */\n  btnPlayNext.on('click', function (event) {\n    event.preventDefault();\n    secondTimer.stop();\n    // 세션 종료로그를 기록한다.\n    sessionProgressEndLogger();\n  });\n\n  /**\n   * 세션 종료일시 로깅\n   */\n  function sessionProgressEndLogger () {\n    $.ajax({\n      type: 'POST',\n      url: '/session/log/endtime',\n      data: {\n        training_user_id: playerContainer.data('training-user-id'),\n        course_id: playerContainer.data('course-id'),\n        course_list_id: playerContainer.data('course-list-id')\n      }\n    }).done(function (res) {\n      if (!res.success) {\n        console.error(res.msg);\n      } else {\n        window.location.href = nextUrl;\n      }\n    });\n  }\n\n  /**\n   * 총 릴타임의 80% 이상을 시청한 경우 다음버튼을 활성화 한다.\n   */\n  function showPlayBtn () {\n    if (playerContainer.data('status') === 'done') {\n      btnPlayNext.removeClass('blind');\n      btnReplayVideo.addClass('blind');\n    }\n  }\n\n  /**\n   * 세션 비디오 로그를 삭제한다.\n   */\n  function deleteVideoLog () {\n    return axios.delete('/video/log', {\n      params: {\n        video_id: playerContainer.data('id')\n      }\n    })\n    .then(function (response) {\n    })\n    .catch(function (error) {\n      console.error(error);\n    });\n  }\n\n  // 세션 로그를 삭제한다.\n  function deleteSessionLog () {\n    return axios.delete('/session/log', {\n      params: {\n        training_user_id: playerContainer.data('training-user-id'),\n        course_list_id: playerContainer.data('course-list-id')\n      }\n    })\n    .then(function (response) {\n    })\n    .catch(function (error) {\n      console.error(error);\n    });\n  }\n\n  // btnReplayVideo.on('click', function (e) {\n  //   e.preventDefault();\n  //   player.unload().then(function () {\n  //     btnReplayVideo.addClass('blind');\n  //   }).catch(function (error) {\n  //     console.log(error);\n  //   });\n  // });\n});\n"]}