{"version":3,"sources":["video.js"],"names":["requirejs","passiveRate","playerContainer","initPlayer","videoDuration","console","setPlayer","player","catch","then","error","getDuration","duration","videoLastPlayedTime","setCurrentTime","window","confirm","seconds","pause","timerLog","$","timer","timerLoggingInterval","videoPlayTimeLogger","stop","checkVideoDuration","btnPlayNext","showPlayBtn","totalPlayedSeconds","Math","floor","addClass","btnReplayVideo","getCurrentTime","videoCurrentTime","video_id","ajax","log","type","removeClass","url","data","video_duration","currenttime","msg","videoId","played_seconds","timerLogPlayedSeconds","done","res","videoTotalPlayedSeconds","total_played_seconds","success","sessionProgressStartLogger","trainingUserId","course_id","courseId","sessionHasEnded","hasEnded","sessionProgressEndLogger","course_list_id","courseListId","waitingTimeLogger","nextUrl","deleteVideoLog","deleteSessionLog","params","response","delete","event","training_user_id","secondTimer","waitMessage","attr","Timer","loop","reset","preventDefault","on","info","setTimeout","start","countdown","getTimeValues","videoEndTimeLogger","startValues","html","toString","addEventListener","e","axios","res1","res2","reload","unload"],"mappings":"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","file":"../javascripts/video.js","sourcesContent":["/**\n * 비디오 세션 학습\n */\n\n'use strict';\n\nrequirejs(\n  [\n    'jquery',\n    'axios',\n    'Vimeo',\n    'easyTimer',\n    'jqueryTimer'\n  ],\nfunction ($, axios, Vimeo, Timer) {\n  var player = null;\n  var playerContainer = $('.videoplayer');\n  var timerLoggingInterval = playerContainer.data('interval'); // log every 5 seconds\n  var timerLog = null;\n  var timerWait = null; // 비디오 시청 종료 후 다음 버튼을 누르도록 강요하는 타이머\n  var timerLogPlayedSeconds = 0; // 시청시간(초)\n  var timerWaitingSeconds = playerContainer.data('wait-seconds'); // 다음버튼을 노출하는데 까지 대기하는 시간\n  var passiveRate = playerContainer.data('passive-rate'); // 다음 버튼을 노출하는 시점\n  var videoDuration = null; // 비디오 러닝타임\n  var waitMessage = $('#countdown .values'); // $('.wait-message');\n  var sessionHasEnded = false;\n  var videoCurrentTime; // 비디오 현재 시청시간\n\n  // element cache\n  var btnPlayNext = $('#btn_play_next');\n  var nextUrl = btnPlayNext.parent().attr('href');\n  var btnReplayVideo = $('#btn_replay_video');\n\n  // element data\n  var videoId = playerContainer.data('id'); // video 테이블의 id\n  var videoTotalPlayedSeconds = playerContainer.data('total-play'); // 비디오 총 시청시간\n  var videoLastPlayedTime = playerContainer.data('current-time'); // 마지막 재생시점\n  var trainingUserId = btnPlayNext.data('training-user-id');\n  var courseId = btnPlayNext.data('course-id');\n  var courseListId = btnPlayNext.data('course-list-id');\n\n  var secondTimer = new Timer();\n\n/**\n * entry point\n */\n  $(function () {\n    initPlayer();\n  });\n\n  /**\n   * Player 를 초기화 한다.\n   */\n  function initPlayer () {\n    var options = {\n      loop: false\n    };\n    player = new Vimeo('videoplayer', options);\n    player.setVolume(0.5); // 볼륨설정\n    player.ready().then(function () {\n      console.info('Player is ready.');\n\n      player.getDuration().then(function (duration) {\n        console.log('duration : ', duration);\n\n        videoDuration = duration; // 비디오 지속시간 구하기\n        setPlayer();\n      }).catch(function (error) {\n        console.error(error);\n      });\n\n      if (videoLastPlayedTime < videoDuration - 5) {\n        if (window.confirm('마지막 재생시점으로 이동하시겠습니까?')) {\n          player.setCurrentTime(videoLastPlayedTime).then(function (seconds) {\n            player.pause();\n          }).catch(function (error) {\n            console.error(error);\n          });\n        }\n      }\n    }).catch(function (error) {\n      console.error(error);\n    });\n\n    // player.enableTextTrack('ko').then(function (track) {\n    //   track.language = 'kr';\n    //   track.kind = 'subtitles';\n    //   track.label = 'hahaha';\n    // })\n    // .catch(function (error) {\n    //   console.log('track : ' + error);\n    // });\n  }\n\n  /**\n   * Player 를 셋팅한다.\n   */\n  function setPlayer () {\n    if (videoDuration) {\n      timerLog = $.timer(1000 * timerLoggingInterval, videoPlayTimeLogger, true);\n      timerLog.stop();\n      checkVideoDuration();\n    } else {\n      console.error('재생시간을 확인할 수 없습니다.');\n    }\n  }\n\n  /**\n   * 비디오 재생시간이 존재하는지 여부 체크\n   */\n  function checkVideoDuration () {\n  // videoDuration = getPlayerDuration();\n  // 총 릴타임의 80% 이상을 시청한 경우 다음버튼을 활성화 한다.\n    showPlayBtn(videoTotalPlayedSeconds);\n  }\n\n  /**\n   * 총 릴타임의 80% 이상을 시청한 경우 다음버튼을 활성화 한다.\n   */\n  function showPlayBtn (totalPlayedSeconds) {\n    if (Math.floor(videoDuration * (passiveRate / 100)) <= totalPlayedSeconds) {\n      btnPlayNext.removeClass('blind');\n      btnReplayVideo.addClass('blind');\n    }\n  }\n\n  /**\n   * 시청시간 로깅\n   */\n  function videoPlayTimeLogger () {\n    console.log('logging...');\n    timerLogPlayedSeconds += timerLoggingInterval;\n\n    player.getCurrentTime().then(function (seconds) {\n      if ((videoCurrentTime > 0) && videoCurrentTime === seconds) {\n        player.pause().then(function () {\n          console.log('비디오가 중지되었습니다.');\n          btnReplayVideo.removeClass('blind');\n        }).catch(function (error) {\n          console.error(error);\n        });\n        return;\n      }\n      videoCurrentTime = seconds;\n      $.ajax({\n        type: 'POST',\n        url: '/video/log/playtime',\n        data: {\n          training_user_id: trainingUserId,\n          video_id: videoId,\n          played_seconds: timerLogPlayedSeconds,\n          video_duration: videoDuration,\n          currenttime: seconds\n        }\n      }).done(function (res) {\n        if (!res.success) {\n          console.error(res.msg);\n\n          // 오류 발생 시 타이머와 비디오 재생을 멈춘다.\n          player.pause().then(function () {\n          }).catch(function (error) {\n            console.error(error);\n          });\n        } else {\n          timerLogPlayedSeconds = 0;\n          // 총 릴타임의 80% 이상을 시청한 경우 다음버튼을 활성화 한다.\n          videoTotalPlayedSeconds = res.total_played_seconds;\n          showPlayBtn(videoTotalPlayedSeconds);\n        }\n      });\n    }).catch(function (error) {\n      console.error(error);\n    });\n  }\n\n  /**\n   * 비디오 시청 종료시간 로깅\n   */\n  function videoEndTimeLogger () {\n    console.log('video log end');\n    $.ajax({\n      type: 'POST',\n      url: '/video/log/endtime',\n      data: {\n        video_id: videoId\n      }\n    }).done(function (res) {\n      if (!res.success) {\n        console.error(res.msg);\n      } else {\n      // console.info('종료시간 기록!');\n      }\n    });\n  }\n\n  /**\n   * 세션 시작일시 로깅\n   */\n  function sessionProgressStartLogger () {\n    console.log('session log start');\n    $.ajax({\n      type: 'POST',\n      url: '/session/log/starttime',\n      data: {\n        training_user_id: trainingUserId,\n        course_id: courseId,\n        course_list_id: courseListId\n      }\n    }).done(function (res) {\n      if (!res.success) {\n        console.error(res.msg);\n      // 오류 발생 시 타이머와 비디오 재생을 멈춘다.\n        timerLog.stop();\n        player.stop();\n      } else {\n        sessionHasEnded = res.hasEnded; // 세션 종료여부\n      }\n    });\n  }\n\n  /**\n   * 세션 종료일시 로깅\n   */\n  function sessionProgressEndLogger () {\n    console.log('session log end');\n    $.ajax({\n      type: 'POST',\n      url: '/session/log/endtime',\n      data: {\n        training_user_id: trainingUserId,\n        course_id: courseId,\n        course_list_id: courseListId\n      }\n    }).done(function (res) {\n      if (!res.success) {\n        console.error(res.msg);\n      // 오류 발생 시 타이머와 비디오 재생을 멈춘다.\n        timerLog.stop();\n        player.stop();\n      } else {\n        // console.info('세션 종료시간 기록');\n        window.location.href = nextUrl;\n      }\n    });\n  }\n\n  /**\n   * 정해진 시간 내에 다음 버튼을 누르지 않을 경우\n   * 학습을 초기화 하는 타이머 컨트롤러\n   */\n  function waitingTimeLogger () {\n    timerWaitingSeconds -= 1;\n    waitMessage.html(' ( ' + timerWaitingSeconds + ' 초 이내 클릭 )');\n\n    // 세션과 비디오 로그를 삭제한다.\n    if (timerWaitingSeconds <= 0) {\n      timerWait.stop();\n      window.alert('비디오를 재시청 해주시기 바랍니다.');\n\n      axios.all([ deleteVideoLog(), deleteSessionLog() ])\n        .then(axios.spread(function (res1, res2) {\n          window.location.reload();\n        }));\n    }\n  }\n\n  /**\n   * 세션 비디오 로그를 삭제한다.\n   */\n  function deleteVideoLog () {\n    return axios.delete('/video/log', {\n      params: {\n        video_id: videoId\n      }\n    })\n    .then(function (response) {\n    })\n    .catch(function (error) {\n      console.error(error);\n    });\n  }\n\n  // 세션 로그를 삭제한다.\n  function deleteSessionLog () {\n    return axios.delete('/session/log', {\n      params: {\n        training_user_id: trainingUserId,\n        course_list_id: courseListId\n      }\n    })\n    .then(function (response) {\n    })\n    .catch(function (error) {\n      console.error(error);\n    });\n  }\n\n/**\n * 다음버튼 클릭 시 발생 이벤트\n */\n  btnPlayNext.on('click', function (event) {\n    event.preventDefault();\n\n    secondTimer.stop();\n    // 세션 종료로그를 기록한다.\n    sessionProgressEndLogger();\n  });\n\n  /**\n   * Player 재생 시 발생\n   */\n  player.on('play', function (data) {\n    // secondTimer.reset();\n    // 세션시작로그\n    sessionProgressStartLogger();\n    // 로깅 시간간격 설정\n    timerLog.reset(1000 * timerLoggingInterval);\n  });\n\n  /**\n   * Player 일시정지 시 발생\n   */\n  player.on('error', function (data) {\n    console.info('error!');\n    console.error(data);\n  });\n\n  /**\n   * Player 일시정지 시 발생\n   */\n  player.on('pause', function (data) {\n    console.info('player: pause');\n    // 로깅 일시정지\n    timerLog.pause();\n    // 비디오 시청 종료일시 기록\n    videoEndTimeLogger();\n  });\n\n/**\n * Player 종료 시 발생\n */\n  player.on('ended', function (data) {\n    console.info('player: ended');\n    // 로깅 일시정지\n    timerLog.pause();\n    // 총 시청시간에 따라 다음 버튼 표시\n    showPlayBtn(videoTotalPlayedSeconds + timerLoggingInterval);\n    // 비디오 시청 종료일시 기록\n    videoEndTimeLogger();\n    // 세션 종료 시 대기 타이머 시작\n    if (!sessionHasEnded) {\n      setTimeout(function () {\n        // timerWait = $.timer(1000 * 1, waitingTimeLogger, true);\n\n        $('.timer').removeClass('blind');\n\n        console.log('second timer started');\n        secondTimer.start({countdown: true, startValues: {seconds: 30}});\n\n        waitMessage.html(secondTimer.getTimeValues().toString() + ' 초 이내 <b>다음</b> 버튼을 클릭해주세요.');\n\n        secondTimer.addEventListener('secondsUpdated', function (e) {\n          waitMessage.html(secondTimer.getTimeValues().toString() + ' 초 이내 <b>다음</b> 버튼을 클릭해주세요.');\n        });\n\n        secondTimer.addEventListener('targetAchieved', function (e) {\n          waitMessage.html('학습 초기화 중입니다..');\n\n          setTimeout(function () {\n            window.alert('30초 동안 다음 버튼을 누르지 않아 학습을 초기화 하였습니다.\\n\\n재시청 해주시기 바랍니다.');\n\n            axios.all([ deleteVideoLog(), deleteSessionLog() ])\n            .then(axios.spread(function (res1, res2) {\n              window.location.reload();\n            }));\n          }, 3000);\n        });\n      }, 1000);\n    }\n  });\n\n  // player.on('timeupdate', function (event) {\n  //   console.log(event.percent);\n  // });\n\n  btnReplayVideo.on('click', function (e) {\n    e.preventDefault();\n    player.unload().then(function () {\n      btnReplayVideo.addClass('blind');\n    }).catch(function (error) {\n      console.log(error);\n    });\n  });\n});\n"]}